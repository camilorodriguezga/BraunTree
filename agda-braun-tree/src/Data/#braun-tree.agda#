open import Data.stlib.bt-bool

module Data.braun-tree{â„“} (A : Set â„“) (_<A_ : A â†’ A â†’ ð”¹) where

open import Data.stlib.bt-bool-thms
open import Data.stlib.bt-eq
open import Data.stlib.bt-nat
open import Data.stlib.bt-nat-thms
open import Data.stlib.bt-product
open import Data.stlib.bt-sum

-- the index n is the size of the tree (number of elements of type A)
data BraunTree : (n : â„•) â†’ Set â„“ where
  btEmpty : BraunTree 0
  btNode  : âˆ€ {m n : â„•} â†’ 
            A â†’ BraunTree m â†’ BraunTree n â†’ 
            m â‰¡ n âˆ¨ m â‰¡ suc n â†’ 
            BraunTree (suc (m + n))


{- we will keep smaller (_<A_) elements closer to the root of the Braun tree as we insert -}
btInsert : âˆ€ {n : â„•} â†’ A â†’ BraunTree n â†’ BraunTree (suc n)

btInsert a btEmpty = btNode a btEmpty btEmpty (injâ‚ refl)

btInsert a (btNode{n}{m} a' l r p) 
  rewrite +comm n m with p | if a <A a' then (a , a') else (a' , a)
btInsert a (btNode{n}{m} a' l r _) | injâ‚ p | (a1 , a2) 
  rewrite p = (btNode a1 (btInsert a2 r) l (injâ‚‚ refl))
btInsert a (btNode{n}{m} a' l r _) | injâ‚‚ p | (a1 , a2) = 
  (btNode a1 (btInsert a2 r) l (injâ‚ (sym p)))

mâ‰¡n
btReplaceMin : âˆ€{n : â„•} â†’ A â†’ BraunTree (suc n) â†’ BraunTree (suc n)
btReplaceMin a (btNode _ btEmpty btEmpty u) = (btNode a btEmpty btEmpty u)
btReplaceMin a (btNode _ btEmpty (btNode _ _ _ _) (injâ‚ ()))
btReplaceMin a (btNode _ btEmpty (btNode _ _ _ _) (injâ‚‚ ()))
btReplaceMin a (btNode _ (btNode _ _ _ _) btEmpty (injâ‚ ()))
btReplaceMin a (btNode a' (btNode x l r u) btEmpty (injâ‚‚ y)) with a <A x
btReplaceMin a (btNode a' (btNode x l r u) btEmpty (injâ‚‚ y)) | tt = (btNode a (btNode x l r u) btEmpty (injâ‚‚ y))
btReplaceMin a (btNode a' (btNode x l r u) btEmpty (injâ‚‚ y)) | ff = 
 (btNode x (btReplaceMin a (btNode x l r u)) btEmpty (injâ‚‚ y))
btReplaceMin a (btNode a' (btNode x l r u) (btNode x' l' r' u') v) with a <A x && a <A x' 
btReplaceMin a (btNode a' (btNode x l r u) (btNode x' l' r' u') v) | tt = 
 (btNode a (btNode x l r u) (btNode x' l' r' u') v)
btReplaceMin a (btNode a' (btNode x l r u) (btNode x' l' r' u') v) | ff with x <A x'  
btReplaceMin a (btNode a' (btNode x l r u) (btNode x' l' r' u') v) | ff | tt = 
 (btNode x (btReplaceMin a (btNode x l r u)) (btNode x' l' r' u') v)
btReplaceMin a (btNode a' (btNode x l r u) (btNode x' l' r' u') v) | ff | ff = 
 (btNode x' (btNode x l r u) (btReplaceMin a (btNode x' l' r' u')) v)
 

{- thanks to MatÃ­as Giovannini for the excellent post
     http://alaska-kamtchatka.blogspot.com/2010/02/braun-trees.html
   explaining how to do delete -}
btDeleteMin : âˆ€ {p : â„•} â†’ BraunTree (suc p) â†’ BraunTree p
btDeleteMin (btNode a btEmpty btEmpty u) = btEmpty
btDeleteMin (btNode a btEmpty (btNode _ _ _ _) (injâ‚ ()))
btDeleteMin (btNode a btEmpty (btNode _ _ _ _) (injâ‚‚ ()))
btDeleteMin (btNode a (btNode{m'}{n'} a' l' r' u') btEmpty u) rewrite +0 (m' + n') = btNode a' l' r' u'
btDeleteMin (btNode a
                (btNode{m}{n} x l1 r1 u1)
                (btNode{m'}{n'} x' l2 r2 u2) u) 
  rewrite +suc(m + n)(m' + n') | +suc m (n + (m' + n')) 
        | +comm(m + n)(m' + n') = 
  if (x <A x') then
    (btNode x (btNode x' l2 r2 u2)
      (btDeleteMin (btNode x l1 r1 u1)) (lem{m}{n}{m'}{n'} u))
  else
    (btNode x' (btReplaceMin x (btNode x' l2 r2 u2))
      (btDeleteMin (btNode x l1 r1 u1)) (lem{m}{n}{m'}{n'} u))
  where lem : {m n m' n' : â„•} â†’ suc (m + n) â‰¡ suc (m' + n') âˆ¨ suc (m + n) â‰¡ suc (suc (m' + n')) â†’ 
              suc (m' + n') â‰¡ m + n âˆ¨ suc (m' + n') â‰¡ suc (m + n)
        lem{m}{n}{m'}{n'} (injâ‚ x) = injâ‚‚ (sym x)
        lem (injâ‚‚ y) = injâ‚ (sym (suc-inj y))

btRemoveMin : âˆ€ {p : â„•} â†’ BraunTree (suc p) â†’ A Ã— BraunTree p
btRemoveMin (btNode a l r u) = a , btDeleteMin (btNode a l r u)
